<!DOCTYPE html>
<html lang="en">
<head>
    <title>FLEX-IT-OUT - Real-Time Fitness Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #3d0000);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }
        #app {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }
        video, canvas {
            background: black;
            border: 2px solid #ff1e1e;
            border-radius: 10px;
            max-width: 100%;
        }
        #feedback, #counter {
            position: absolute;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #feedback { top: 10px; left: 10px; }
        #counter { top: 10px; right: 10px; }

        table {
            border: 2px solid red;
            background: black;
            color: white;
            margin-top: 8px;
            width: 200px;
            text-align: center;
        }
        table th, table td {
            border: 1px solid red;
            padding: 5px;
        }
    </style>
</head>
<body>

<div id="app">
    <h1>ðŸ’ª FLEX-IT-OUT - Real-Time Fitness Tracker</h1>
    <div style="position: relative;">
        <video id="video" width="960" height="720" autoplay playsinline></video>
        <canvas id="canvas" width="960" height="720"></canvas>
        <div id="feedback">Loading...</div>
    </div>
    <table>
        <tr>
            <th>Exercise</th>
            <th>Reps</th>
        </tr>
        <tr>
            <td>Squats</td>
            <td id="squatCount">0</td>
        </tr>
        <tr>
            <td>Push-ups</td>
            <td id="pushupCount">0</td>
        </tr>
    </table>
</div>

<script>
const STATE = {
    mode: 'unknown', // squat, pushup, plank
    squatCount: 0,
    pushupCount: 0,
    plankActive: false,
    inPosition: false,
};

const videoElement = document.getElementById('video');
const canvasElement = document.getElementById('canvas');
const ctx = canvasElement.getContext('2d');

function calculateAngle(a, b, c) {
    const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
    let angle = Math.abs(radians * 180 / Math.PI);
    if (angle > 180) angle = 360 - angle;
    return angle;
}

function detectMode(landmarks) {
    const leftShoulder = landmarks[11], rightShoulder = landmarks[12];
    const leftHip = landmarks[23], rightHip = landmarks[24];

    const shoulderY = (leftShoulder.y + rightShoulder.y) / 2;
    const hipY = (leftHip.y + rightHip.y) / 2;

    if (Math.abs(shoulderY - hipY) > 0.3) {
        return 'squat';
    } else {
        const leftElbow = landmarks[13], rightElbow = landmarks[14];
        const leftElbowAngle = calculateAngle(landmarks[11], leftElbow, landmarks[15]);
        const rightElbowAngle = calculateAngle(landmarks[12], rightElbow, landmarks[16]);

        const avgElbowAngle = (leftElbowAngle + rightElbowAngle) / 2;
        if (avgElbowAngle >= 80 && avgElbowAngle <= 100) {
            return 'plank';
        } else {
            return 'pushup';
        }
    }
}

function updateRepsTable() {
    document.getElementById('squatCount').innerText = STATE.squatCount;
    document.getElementById('pushupCount').innerText = STATE.pushupCount;
}

function analyzePose(landmarks) {
    const mode = detectMode(landmarks);
    const feedbackDiv = document.getElementById('feedback');

    if (mode !== STATE.mode) {
        STATE.inPosition = false;
        STATE.plankActive = false;
        STATE.mode = mode;
    }

    if (mode === 'squat') {
        const kneeAngle = (calculateAngle(landmarks[24], landmarks[26], landmarks[28]) +
                          calculateAngle(landmarks[23], landmarks[25], landmarks[27])) / 2;

        feedbackDiv.innerHTML = `Squat Mode<br>Knee Angle: ${Math.round(kneeAngle)}Â°`;

        if (kneeAngle < 100) {
            STATE.inPosition = true;
        } else if (STATE.inPosition && kneeAngle > 150) {
            STATE.squatCount++;
            STATE.inPosition = false;
            updateRepsTable();
        }
    }

    if (mode === 'pushup') {
        const elbowAngle = (calculateAngle(landmarks[11], landmarks[13], landmarks[15]) +
                            calculateAngle(landmarks[12], landmarks[14], landmarks[16])) / 2;

        feedbackDiv.innerHTML = `Push-Up Mode<br>Elbow Angle: ${Math.round(elbowAngle)}Â°`;

        if (elbowAngle < 80) {
            STATE.inPosition = true;
        } else if (STATE.inPosition && elbowAngle > 160) {
            STATE.pushupCount++;
            STATE.inPosition = false;
            updateRepsTable();
        }
    }

    if (mode === 'plank') {
        feedbackDiv.innerHTML = "Plank Mode<br>Hold that position!";
        STATE.plankActive = true;
    }
}

function drawLandmarks(landmarks) {
    ctx.clearRect(0, 0, canvasElement.width, canvasElement.height);

    const connections = [
        [11, 12], [11, 13], [13, 15], [12, 14], [14, 16],
        [11, 23], [12, 24], [23, 25], [25, 27], [24, 26], [26, 28]
    ];

    connections.forEach(([a, b]) => {
        const pa = landmarks[a], pb = landmarks[b];
        ctx.beginPath();
        ctx.moveTo(pa.x * canvasElement.width, pa.y * canvasElement.height);
        ctx.lineTo(pb.x * canvasElement.width, pb.y * canvasElement.height);
        ctx.strokeStyle = '#00ff00';
        ctx.lineWidth = 5;
        ctx.stroke();
    });

    landmarks.forEach(pt => {
        const x = pt.x * canvasElement.width, y = pt.y * canvasElement.height;
        ctx.beginPath();
        ctx.arc(x, y, 8, 0, 2 * Math.PI);
        ctx.fillStyle = '#ff1e1e';
        ctx.fill();
    });
}

const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
pose.setOptions({modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7});
pose.onResults(results => {
    if (results.poseLandmarks) {
        drawLandmarks(results.poseLandmarks);
        analyzePose(results.poseLandmarks);
    }
});

new Camera(videoElement, {onFrame: async () => await pose.send({image: videoElement}), width: 1280, height: 720}).start();
</script>
</body>
</html>
